<!DOCTYPE html>
<html lang="en" class="h-full dark"> <!-- 'dark' class permanently added here for consistent dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Mailbox Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Make calendar rows fill available vertical space */
        .calendar-grid {
            /* This ensures the 6 weeks evenly divide the remaining vertical space (42 cells total) */
            grid-template-rows: repeat(6, 1fr); 
        }
    </style>
</head>
<!-- CHANGE: bg-gray-900 -> bg-black for true dark mode -->
<body class="bg-black text-gray-200 transition-colors duration-300 h-full overflow-hidden">

    <!-- Outermost container removed padding -->
    <div class="h-full">
        <!-- CHANGE: bg-gray-800 -> bg-gray-950 -->
        <div class="bg-gray-950 rounded-none shadow-xl h-full flex flex-col">
             <!-- Header with Logo -->
            <!-- CHANGE: border-gray-700 -> border-gray-800 -->
            <div class="relative flex justify-center items-center px-4 pt-4 pb-2 mb-2 border-b border-gray-800">
                <!-- Centered Client Logo: Updated to use the specified URL -->
                <img src="https://tcbns.com/wp-content/uploads/2021/05/TCBNS_Full_Simp_Light.png" alt="Client Logo" class="h-8 md:h-10 rounded-lg">

                <!-- Theme Toggle Button was removed -->
            </div>
            
            <!-- Calendar Header -->
            <!-- Applied horizontal padding internally (px-4) -->
            <div class="flex justify-between items-center mb-2 px-4">
                <!-- CHANGE: hover:bg-gray-700 -> hover:bg-gray-800 -->
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="month-year-header" class="text-xl md:text-2xl font-semibold text-gray-300"></h2>
                <!-- CHANGE: hover:bg-gray-700 -> hover:bg-gray-800 -->
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            
            <!-- This container now correctly starts right after the header's margin -->
            <div class="flex flex-col flex-grow px-4"> <!-- px-4 added here to align grid with header elements -->
                <div id="loader" class="mx-auto loader"></div>
                <div id="error-message" class="hidden text-center text-red-400 bg-red-900/40 p-4 rounded-lg"></div>
                
                <!-- Calendar Grid -->
                <div id="calendar-container" class="hidden flex flex-col flex-grow">
                    <!-- CHANGE: border-gray-700 -> border-gray-800 -->
                    <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-400 border-b border-gray-800 pb-2">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 calendar-grid flex-grow">
                        <!-- Day cells will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // The API URL is now set with your specific endpoint.
        const BACKEND_API_URL = "https://ovudn62nv4.execute-api.us-east-1.amazonaws.com/default/CalendarWebApp";

        const loader = document.getElementById('loader');
        const errorMessageContainer = document.getElementById('error-message');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearHeader = document.getElementById('month-year-header');
        const calendarContainer = document.getElementById('calendar-container');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        
        let currentDate = new Date();
        let allFetchedEvents = [];

        // Main function to call our secure backend
        async function fetchAndRenderCalendar() {
            errorMessageContainer.classList.add('hidden');
            loader.classList.remove('hidden');
            calendarContainer.classList.add('hidden');

            try {
                // Original fetch call to your API
                const response = await fetch(BACKEND_API_URL);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Request failed with status: ${response.status}`);
                }
                allFetchedEvents = await response.json();
                renderCalendar();
            } catch (error) {
                console.error('An error occurred:', error);
                // If API fails, show error message
                showError(`Failed to fetch calendar events from API: ${error.message}.`);
                // Fallback to minimal rendering if data fetch fails
                allFetchedEvents = []; 
                renderCalendar();
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Function to render the calendar and place events
        function renderCalendar() {
            calendarGrid.innerHTML = ''; // Clear previous grid
            const today = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();

            monthYearHeader.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Calendar calculations
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); // 0 (Sun) to 6 (Sat)
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            const currentMonthYearStr = currentYear + "-" + (currentMonth + 1).toString().padStart(2, '0');
            
            let dayCount = 0; // Total days rendered (max 42)

            // --- 1. Previous Month Overflow Days ---
            for (let i = firstDayOfMonth; i > 0; i--) {
                const day = daysInPrevMonth - i + 1;
                const prevDate = new Date(currentYear, currentMonth - 1, day);
                const dayDateStr = prevDate.toISOString().split('T')[0];
                
                // Muted style for previous month days
                // CHANGE: border-gray-700 -> border-gray-800
                // CHANGE: hover:bg-gray-700/70 -> hover:bg-gray-800/70
                // CHANGE: bg-gray-900/40 -> bg-gray-900 (solid for darker look)
                let dayCellClasses = "border border-gray-800 rounded-lg px-2 pt-1 pb-0 text-sm text-left flex flex-col transition-colors duration-200 hover:bg-gray-800/70 bg-gray-900";
                let dayNumberClasses = 'font-bold text-gray-600'; // Darker text for inactive days

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="${dayCellClasses}">
                        <div class="${dayNumberClasses}">${day}</div>
                        <div id="events-${dayDateStr}" class="space-y-1 overflow-y-auto flex-grow h-0"></div>
                    </div>
                `);
                dayCount++;
            }

            // --- 2. Current Month Days ---
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayDateStr = dayDate.toISOString().split('T')[0];
                const isToday = dayDate.toDateString() === today.toDateString();
                
                // Day cell padding is minimal: px-2 pt-1 pb-0
                // CHANGE: border-gray-700 -> border-gray-800
                // CHANGE: hover:bg-gray-700/70 -> hover:bg-gray-800/70
                let dayCellClasses = "border border-gray-800 rounded-lg px-2 pt-1 pb-0 text-sm text-left flex flex-col transition-colors duration-200 hover:bg-gray-800/70";
                let dayNumberClasses = 'font-bold';

                if (isToday) {
                    // Accent color is kept but base is darker
                    dayCellClasses += " bg-blue-900/40 border-blue-700";
                    dayNumberClasses += ' text-blue-400';
                } else {
                    // CHANGE: bg-gray-800 -> bg-gray-950
                    dayCellClasses += " bg-gray-950";
                    dayNumberClasses += ' text-gray-300'; // Active month text color
                }

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="${dayCellClasses}">
                        <div class="${dayNumberClasses}">${day}</div>
                        <div id="events-${dayDateStr}" class="space-y-1 overflow-y-auto flex-grow h-0"></div>
                    </div>
                `);
                dayCount++;
            }

            // --- 3. Next Month Overflow Days (Fill remaining 42 cells) ---
            let nextDay = 1;
            while (dayCount < 42) {
                const nextDate = new Date(currentYear, currentMonth + 1, nextDay);
                const dayDateStr = nextDate.toISOString().split('T')[0];
                
                // Muted style for next month days
                // CHANGE: border-gray-700 -> border-gray-800
                // CHANGE: hover:bg-gray-700/70 -> hover:bg-gray-800/70
                // CHANGE: bg-gray-900/40 -> bg-gray-900 (solid for darker look)
                let dayCellClasses = "border border-gray-800 rounded-lg px-2 pt-1 pb-0 text-sm text-left flex flex-col transition-colors duration-200 hover:bg-gray-800/70 bg-gray-900";
                let dayNumberClasses = 'font-bold text-gray-600'; // Darker text for inactive days

                calendarGrid.insertAdjacentHTML('beforeend', `
                    <div class="${dayCellClasses}">
                        <div class="${dayNumberClasses}">${nextDay}</div>
                        <div id="events-${dayDateStr}" class="space-y-1 overflow-y-auto flex-grow h-0"></div>
                    </div>
                `);
                nextDay++;
                dayCount++;
            }

            // Place events into their respective day cells
            allFetchedEvents.forEach(event => {
                const eventStartDate = new Date(event.start.dateTime);
                const eventDateStr = eventStartDate.toISOString().split('T')[0];
                const eventMonthYearStr = eventStartDate.getFullYear() + "-" + (eventStartDate.getMonth() + 1).toString().padStart(2, '0');

                // Only render events that fall within the current 42-day view period (including overflow days)
                const targetContainer = document.getElementById(`events-${eventDateStr}`);

                if (targetContainer) {
                    const eventTime = eventStartDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    const eventElement = document.createElement('div');
                    
                    // Classes simplified for dark mode
                    eventElement.className = 'bg-green-700/30 text-green-200 p-1 rounded-md text-xs font-medium whitespace-normal break-words shadow-sm';
                    eventElement.textContent = `${eventTime} - ${event.subject}`;
                    eventElement.title = `${eventTime} - ${event.subject}`;
                    targetContainer.appendChild(eventElement);
                }
            });

            calendarContainer.classList.remove('hidden');
        }
        
        function showError(message) {
            errorMessageContainer.textContent = message;
            errorMessageContainer.classList.remove('hidden');
            loader.classList.add('hidden');
        }

        // Navigation event listeners
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            fetchAndRenderCalendar(); // Re-fetch or re-render
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            fetchAndRenderCalendar(); // Re-fetch or re-render
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderCalendar();
        });
    </script>
</body>
</html>
